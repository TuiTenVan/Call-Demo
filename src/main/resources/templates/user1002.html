<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User 1002: Receive a Call</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sip.js/0.20.0/sip.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f2f2f2;
            text-align: center;
        }
        #callUI {
            display: none;
            width: 350px;
            background-color: #1a2b48;
            padding: 20px;
            border-radius: 20px;
            color: white;
            text-align: center;
            position: relative;
            margin: 50px auto;
        }
        #callUI .call-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        #callUI .call-header img {
            border-radius: 50%;
            width: 60px;
            height: 60px;
        }
        #callUI .call-header .call-info {
            flex: 1;
            text-align: left;
            padding-left: 10px;
        }
        #callUI .call-header .call-status {
            background-color: #ffd700;
            padding: 5px 10px;
            border-radius: 10px;
            color: black;
        }
        #callUI .call-controls {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        .call-controls button {
            background-color: #1a2b48;
            border: none;
            color: white;
            padding: 15px;
            font-size: 18px;
            cursor: pointer;
            border-radius: 50%;
            width: 60px;
            height: 60px;
        }
        .call-controls button:hover {
            background-color: #3b4a6b;
        }
        .call-controls #endCall {
            background-color: #f44336;
        }
        .call-controls #endCall:hover {
            background-color: #ff5c5c;
        }
        /* Giao di·ªán quay s·ªë */
        .dial-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-gap: 10px;
            margin-top: 20px;
        }
        .dial-pad button {
            background-color: #1a2b48;
            border: none;
            color: white;
            font-size: 24px;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
        }
        .dial-pad button:hover {
            background-color: #3b4a6b;
        }
        #videoContainer {
            margin-top: 15px;
        }
        #videoContainer video {
            width: 100%;
            border-radius: 10px;
        }
    </style>
</head>
<body>

<h1>User 1002: Ready to Receive Calls</h1>

<!-- Tr∆∞·ªùng hi·ªÉn th·ªã giao di·ªán cu·ªôc g·ªçi -->
<div id="callUI">
    <div id="videoContainer">
        <video id="localVideo" autoplay muted></video>
        <video id="remoteVideo" autoplay></video>
    </div>

    <div class="call-controls">
        <button id="muteAudio">üîá</button> <!-- T·∫Øt ti·∫øng -->
        <button id="toggleVideo">üé•</button> <!-- T·∫Øt/b·∫≠t video -->
        <button id="endCall">üî¥</button> <!-- K·∫øt th√∫c cu·ªôc g·ªçi -->
    </div>

    <!-- B√†n ph√≠m quay s·ªë DTMF -->
    <div class="dial-pad">
        <button id="dtmf1">1</button>
        <button id="dtmf2">2</button>
        <button id="dtmf3">3</button>
        <button id="dtmf4">4</button>
        <button id="dtmf5">5</button>
        <button id="dtmf6">6</button>
        <button id="dtmf7">7</button>
        <button id="dtmf8">8</button>
        <button id="dtmf9">9</button>
        <button id="dtmfStar">*</button>
        <button id="dtmf0">0</button>
        <button id="dtmfHash">#</button>
    </div>
</div>

<script>
    let userAgent;
    let localStream;
    let activeSession;

    // L·∫•y video t·ª´ camera v√† micro
    function getLocalStream() {
        return navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                localStream = stream;
                document.getElementById('localVideo').srcObject = stream;  // Hi·ªÉn th·ªã camera local
                return stream;
            })
            .catch(error => {
                console.error("Error accessing media devices.", error);
            });
    }

    window.onload = function () {
        userAgent = new SIP.UserAgent({
            uri: new SIP.URI("sip", "1002", "192.168.1.183", 5070),
            transportOptions: {
                wsServers: ['ws://192.168.1.183:5066']
            },
            authorizationUsername: '1002',
            authorizationPassword: '1234'
        });

        userAgent.start()
            .then(() => {
                console.log("UserAgent for 1002 started successfully");
                const registerer = new SIP.Registerer(userAgent);
                console.log(registerer)
                registerer.register();
                setupCallReceiving();
            })
            .catch((error) => {
                console.error("Failed to start UserAgent for 1002:", error);
            });

        // T·∫Øt ti·∫øng
        document.getElementById("muteAudio").onclick = function () {
            if (localStream && localStream.getAudioTracks().length > 0) {
                const audioTrack = localStream.getAudioTracks()[0];
                audioTrack.enabled = !audioTrack.enabled;
                this.textContent = audioTrack.enabled ? 'üîá' : 'üîä';
            } else {
                console.error("No audio tracks available in localStream.");
            }
        };

        // T·∫Øt ho·∫∑c b·∫≠t video
        document.getElementById("toggleVideo").onclick = function () {
            if (localStream && localStream.getVideoTracks().length > 0) {
                const videoTrack = localStream.getVideoTracks()[0];
                videoTrack.enabled = !videoTrack.enabled;
                this.textContent = videoTrack.enabled ? 'üé•' : 'üö´';
            } else {
                console.error("No video tracks available in localStream.");
            }
        };

        // K·∫øt th√∫c cu·ªôc g·ªçi
        document.getElementById("endCall").onclick = function () {
            endCall();
        };

        // G·ª≠i DTMF
        document.querySelectorAll(".dial-pad button").forEach(button => {
            button.onclick = function () {
                const dtmfValue = this.textContent;
                sendDTMF(dtmfValue);
            };
        });
    };

    function setupCallReceiving() {
        userAgent.delegate = {
            onInvite: async (invitation) => {
                if (confirm("You have an incoming call. Do you want to accept?")) {
                    try {
                        await getLocalStream();  // G·ªçi getLocalStream ƒë·ªÉ l·∫•y v√† hi·ªÉn th·ªã video/mic c·ªßa ch√≠nh m√¨nh
                        const session = await invitation.accept({
                            sessionDescriptionHandlerOptions: {
                                constraints: {
                                    audio: true,
                                    video: true
                                },
                                localStream: localStream  // Truy·ªÅn localStream v√†o ƒë·ªÉ g·ª≠i video/audio c·ªßa ch√≠nh m√¨nh
                            }
                        });

                        activeSession = session;
                        document.getElementById('callUI').style.display = 'block'; // Hi·ªÉn th·ªã giao di·ªán cu·ªôc g·ªçi
                        console.log(activeSession.sessionDescriptionHandlerOptions())
                        // Hi·ªÉn th·ªã remote v√† local video
                        session.stateChange.addListener((state) => {
                            if (state === SIP.SessionState.Established) {
                                const pc = session.sessionDescriptionHandler.peerConnection;

                                // Khi c√≥ track m·ªõi t·ª´ remote
                                pc.ontrack = (event) => {
                                    const remoteStream = new MediaStream();
                                    event.streams[0].getTracks().forEach(track => {
                                        remoteStream.addTrack(track);
                                    });
                                    document.getElementById('remoteVideo').srcObject = remoteStream;
                                };
                            }
                        });

                    } catch (error) {
                        console.error("Error accepting the call:", error);
                    }
                } else {
                    invitation.reject();
                    console.log("Call rejected");
                }
            }
        };
    }

    // H√†m g·ª≠i DTMF
    function sendDTMF(dtmfValue) {
        if (activeSession && activeSession.sessionDescriptionHandler) {
            const dtmfSender = activeSession.sessionDescriptionHandler.peerConnection.getSenders()
                .find(sender => sender.track && sender.track.kind === 'audio');

            if (dtmfSender && dtmfSender.dtmf) {
                dtmfSender.dtmf.insertDTMF(dtmfValue);
                console.log("DTMF ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng: " + dtmfValue);
            } else {
                console.error("Kh√¥ng th·ªÉ g·ª≠i DTMF.");
            }
        } else {
            console.error("Phi√™n kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng h·ªó tr·ª£ g·ª≠i DTMF.");
        }
    }

    // K·∫øt th√∫c cu·ªôc g·ªçi
    function endCall() {
        if (activeSession) {
            activeSession.bye();
            document.getElementById('callUI').style.display = 'none';  // ·∫®n giao di·ªán cu·ªôc g·ªçi
            console.log("Cu·ªôc g·ªçi ƒë√£ k·∫øt th√∫c.");
        }
    }
</script>
</body>
</html>
