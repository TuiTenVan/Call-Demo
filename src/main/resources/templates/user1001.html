<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User 1001: Make a Call</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sip.js/0.20.0/sip.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background-color: #f2f2f2;
            text-align: center;
        }
        #callUI {
            display: none;
            width: 350px;
            background-color: #1a2b48;
            padding: 20px;
            border-radius: 20px;
            color: white;
            text-align: center;
            position: relative;
            margin: 50px auto;
        }

        #callUI .call-header img {
            border-radius: 50%;
            width: 60px;
            height: 60px;
        }
        #callUI .call-header .call-info {
            flex: 1;
            text-align: left;
            padding-left: 10px;
        }
        #callUI .call-header .call-status {
            background-color: #ffd700;
            padding: 5px 10px;
            border-radius: 10px;
            color: black;
        }
        #callUI .call-controls {
            display: flex;
            justify-content: space-between;
            margin: 20px 0;
        }
        .call-controls button {
            background-color: #1a2b48;
            border: none;
            color: white;
            padding: 15px;
            font-size: 18px;
            cursor: pointer;
            border-radius: 50%;
            width: 60px;
            height: 60px;
        }
        .call-controls button:hover {
            background-color: #3b4a6b;
        }
        .call-controls #endCall {
            background-color: #f44336;
        }
        .call-controls #endCall:hover {
            background-color: #ff5c5c;
        }
        /* Giao di·ªán quay s·ªë */
        .dial-pad {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-gap: 10px;
            margin-top: 20px;
        }
        .dial-pad button {
            background-color: #1a2b48;
            border: none;
            color: white;
            font-size: 24px;
            padding: 20px;
            border-radius: 10px;
            cursor: pointer;
        }
        .dial-pad button:hover {
            background-color: #3b4a6b;
        }
        #videoContainer {
            margin-top: 15px;
        }
        #videoContainer video {
            width: 100%;
            border-radius: 10px;
        }
    </style>
</head>
<body>

<h1>User 1001: Make a Call</h1>

<!-- Tr∆∞·ªùng nh·∫≠p s·ªë SIP ƒë√≠ch ƒë·ªÉ g·ªçi -->
<input type="text" id="sipAddress" placeholder="Enter SIP address (e.g., 1002@192.168.1.183)">
<button id="callButton">Call</button>

<div id="callUI">
    <div id="videoContainer">
        <video id="localVideo" autoplay muted></video>
        <video id="remoteVideo" autoplay></video>
    </div>

    <div class="call-controls">
        <button id="muteAudio">üîá</button> <!-- T·∫Øt ti·∫øng -->
        <button id="toggleVideo">üé•</button> <!-- T·∫Øt/b·∫≠t video -->
        <button id="endCall">üî¥</button> <!-- K·∫øt th√∫c cu·ªôc g·ªçi -->
    </div>

    <!-- B√†n ph√≠m quay s·ªë DTMF -->
    <div class="dial-pad">
        <button id="dtmf1">1</button>
        <button id="dtmf2">2</button>
        <button id="dtmf3">3</button>
        <button id="dtmf4">4</button>
        <button id="dtmf5">5</button>
        <button id="dtmf6">6</button>
        <button id="dtmf7">7</button>
        <button id="dtmf8">8</button>
        <button id="dtmf9">9</button>
        <button id="dtmfStar">*</button>
        <button id="dtmf0">0</button>
        <button id="dtmfHash">#</button>
    </div>
</div>

<script>
    let userAgent;
    let localStream;
    let activeSession;
    let callDuration = 0;
    let callInterval;

    // L·∫•y video t·ª´ camera v√† micro
    function getLocalStream() {
        return navigator.mediaDevices.getUserMedia({ video: true, audio: true })
            .then(stream => {
                localStream = stream;
                document.getElementById('localVideo').srcObject = stream;  // Hi·ªÉn th·ªã camera local
                return stream;
            })
            .catch(error => {
                console.error("Error accessing media devices.", error);
            });
    }

    window.onload = function () {
        userAgent = new SIP.UserAgent({
            uri: new SIP.URI("sip", "1001", "192.168.1.183", 5070),
            transportOptions: {
                wsServers: ['ws://192.168.1.183:5066']
            },
            authorizationUsername: '1001',
            authorizationPassword: '1234'
        });

        userAgent.start()
            .then(() => {
                console.log("UserAgent for 1001 started successfully");
            })
            .catch((error) => {
                console.error("Failed to start UserAgent for 1001:", error);
            });

        // Nh·∫•n n√∫t ƒë·ªÉ th·ª±c hi·ªán cu·ªôc g·ªçi v·ªõi s·ªë SIP ng∆∞·ªùi d√πng ƒë√£ nh·∫≠p
        document.getElementById("callButton").onclick = function () {
            const sipAddress = document.getElementById("sipAddress").value.trim();  // L·∫•y gi√° tr·ªã t·ª´ tr∆∞·ªùng nh·∫≠p
            if (sipAddress) {
                console.log("Attempting to call: ", sipAddress);  // Log ƒë·ªÉ ki·ªÉm tra s·ªë ƒëang g·ªçi
                getLocalStream().then(() => makeCall(sipAddress));  // Th·ª±c hi·ªán cu·ªôc g·ªçi v·ªõi SIP URI ng∆∞·ªùi d√πng ƒë√£ nh·∫≠p
            } else {
                alert("Please enter a valid SIP address.");
            }
        };

        // Nh·∫•n n√∫t "End Call" ƒë·ªÉ k·∫øt th√∫c cu·ªôc g·ªçi
        document.getElementById("endCall").onclick = function () {
            endCall();
        };

        // T·∫Øt ho·∫∑c b·∫≠t √¢m thanh
        document.getElementById("muteAudio").onclick = function () {
            if (localStream && localStream.getAudioTracks().length > 0) {
                const audioTrack = localStream.getAudioTracks()[0];
                audioTrack.enabled = !audioTrack.enabled;
                this.textContent = audioTrack.enabled ? 'üîá' : 'üîä';
            } else {
                console.error("No audio tracks available in localStream.");
            }
        };

        // T·∫Øt ho·∫∑c b·∫≠t video
        document.getElementById("toggleVideo").onclick = function () {
            if (localStream && localStream.getVideoTracks().length > 0) {
                const videoTrack = localStream.getVideoTracks()[0];
                videoTrack.enabled = !videoTrack.enabled;
                this.textContent = videoTrack.enabled ? 'üé•' : 'üö´';
            } else {
                console.error("No video tracks available in localStream.");
            }
        };

        // S·ª± ki·ªán g·ª≠i DTMF cho c√°c n√∫t s·ªë
        document.querySelectorAll(".dial-pad button").forEach(button => {
            button.onclick = function () {
                const dtmfValue = this.textContent;
                sendDTMF(dtmfValue);
            };
        });
    };

    // H√†m th·ª±c hi·ªán cu·ªôc g·ªçi
    function makeCall(targetSIP) {
        const targetURI = new SIP.URI("sip", targetSIP, "192.168.1.183", 5070);

        const inviter = new SIP.Inviter(userAgent, targetURI, {
            sessionDescriptionHandlerOptions: {
                constraints: {
                    audio: true,
                    video: true
                },
                localStream: localStream
            }
        });

        console.log(inviter)

        inviter.invite()
            .then((session) => {
                activeSession = session;
                console.log(session)// L∆∞u phi√™n hi·ªán t·∫°i ƒë·ªÉ c√≥ th·ªÉ k·∫øt th√∫c sau
                console.log(activeSession)
                // Hi·ªÉn th·ªã giao di·ªán cu·ªôc g·ªçi
                document.getElementById('callUI').style.display = 'block';  // Hi·ªÉn th·ªã giao di·ªán khi cu·ªôc g·ªçi b·∫Øt ƒë·∫ßu
                console.log("Call UI displayed");

                // B·∫Øt ƒë·∫ßu ƒë·∫øm th·ªùi gian cu·ªôc g·ªçi
                callDuration = 0;
                callInterval = setInterval(updateCallDuration, 1000);

                console.log("Call initiated successfully");
            })
            .catch((error) => {
                console.error("Failed to start the call:", error);
            });
    }

    // H√†m g·ª≠i DTMF
    function sendDTMF(dtmfValue) {
        // Ki·ªÉm tra xem activeSession c√≥ t·ªìn t·∫°i v√† sessionDescriptionHandler c√≥ h·ªó tr·ª£ sendDTMF kh√¥ng
        if (activeSession || activeSession.sessionDescriptionHandler || activeSession.sessionDescriptionHandler.sendDTMF) {
            try {
                // G·ª≠i DTMF qua sessionDescriptionHandler
                activeSession.sessionDescriptionHandler.sendDTMF(dtmfValue)
                    .then(() => {
                        console.log("DTMF ƒë√£ ƒë∆∞·ª£c g·ª≠i th√†nh c√¥ng: " + dtmfValue);
                    })
                    .catch((error) => {
                        console.error("L·ªói khi g·ª≠i DTMF: ", error);
                    });
            } catch (error) {
                console.error("L·ªói khi g·ª≠i DTMF: ", error);
            }
        } else {
            console.error("Phi√™n kh√¥ng h·ª£p l·ªá ho·∫∑c kh√¥ng h·ªó tr·ª£ g·ª≠i DTMF.");
        }
    }


    // C·∫≠p nh·∫≠t th·ªùi gian cu·ªôc g·ªçi
    function updateCallDuration() {
        callDuration++;
        const minutes = String(Math.floor(callDuration / 60)).padStart(2, '0');
        const seconds = String(callDuration % 60).padStart(2, '0');
        document.querySelector('.call-status').textContent = `${minutes}:${seconds}`;
    }

    // H√†m k·∫øt th√∫c cu·ªôc g·ªçi
    function endCall() {
        if (activeSession) {
            if (typeof activeSession.bye === 'function') {
                activeSession.bye();  // K·∫øt th√∫c cu·ªôc g·ªçi b·∫±ng t√≠n hi·ªáu BYE
                document.getElementById('callUI').style.display = 'none';  // ·∫®n giao di·ªán cu·ªôc g·ªçi
                clearInterval(callInterval);  // D·ª´ng ƒë·∫øm th·ªùi gian cu·ªôc g·ªçi
                console.log("Cu·ªôc g·ªçi ƒë√£ k·∫øt th√∫c.");
            } else {
                console.error("Phi√™n kh√¥ng h·ªó tr·ª£ 'bye'. K·∫øt th√∫c phi√™n b·∫±ng 'terminate'.");
                activeSession.terminate();  // K·∫øt th√∫c phi√™n kh√¥ng c√≥ 'bye'
            }
        } else {
            console.error("Kh√¥ng c√≥ phi√™n ho·∫°t ƒë·ªông ƒë·ªÉ k·∫øt th√∫c.");
        }
    }

</script>
</body>
</html>
